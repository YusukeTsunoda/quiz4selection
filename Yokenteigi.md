# 多肢選択式クイズアプリケーション要件定義書

## 1. システム概要

### 1.1 目的
- ユーザーが様々なカテゴリーと難易度でクイズに挑戦できる
- 学習進捗を追跡・確認できる
- クイズの履歴を確認し、復習できる
- 苦手分野を特定し、効率的な学習を支援する

### 1.2 主要機能

#### クイズ実施機能
- 学年選択（1-6年）
- カテゴリー選択（国語、算数、理科、社会）
- サブカテゴリー選択（カテゴリー別の詳細分野）
- 難易度選択（easy, medium, hard）
- 問題の優先順位付け出題
  - 未回答の問題を優先
  - 低正答率の問題を次に優先
  - その他の問題を最後に出題
- 選択肢のランダム表示
- 即時採点・フィードバック

#### 進捗管理機能
- カテゴリー別の進捗表示
- サブカテゴリー別の進捗表示
- 難易度別の統計情報
  - 受験回数
  - 平均スコア
  - 最高スコア
- 問題ごとの正答率表示

#### 履歴確認機能
- カテゴリー・難易度別の履歴表示
- 各問題の詳細表示
  - 問題文
  - 選択した回答
  - 正解
  - 正誤判定
  - 解説
- 問題ごとの正答率履歴

---

## 2. データベース設計

### 2.1 テーブル構成

#### クイズ履歴（QuizAttempt）
- **ID**（主キー）
- **ユーザーID**（外部キー）
- **学年**
- **カテゴリー**
- **サブカテゴリー**
- **難易度**
- **スコア**
- **総問題数**
- **問題履歴**（JSON）
- **タイムスタンプ**

#### ユーザー（User）
- **ID**（主キー）
- **ユーザー名**
- **メールアドレス**
- **パスワードハッシュ**
- **学年**
- **作成日時**
- **更新日時**

---

## 3. 画面設計

### 3.1 画面一覧

#### 学年選択画面
- 学年一覧表示（1-6年）
- ダッシュボードへのリンク

#### カテゴリー選択画面
- カテゴリー一覧表示
- 選択中の学年表示
- ダッシュボードへのリンク

#### サブカテゴリー選択画面
- サブカテゴリー一覧表示
- 選択中の学年とカテゴリーの表示
- カテゴリー選択への戻るリンク

#### 難易度選択画面
- 難易度一覧表示
- 選択中の学年、カテゴリー、サブカテゴリーの表示
- 各難易度の説明
- サブカテゴリー選択への戻るリンク
- 統計情報の表示

#### クイズ画面
- 進捗バー
- 現在のスコア
- 問題文
- 選択肢（ランダム表示）
- 問題番号
- タイマー（オプション）

#### 結果画面
- 最終スコア
- 不正解問題の復習セクション
  - 問題文
  - 選択した回答
  - 正解
  - 解説
- 再チャレンジボタン
- ダッシュボードへのリンク

#### ダッシュボード
- 学年別進捗
- カテゴリー別進捗
- サブカテゴリー別進捗
- 難易度別統計
- 詳細履歴へのリンク
- 問題ごとの正答率グラフ

#### クイズ履歴画面
- 実施日時
- 学年
- カテゴリー
- サブカテゴリー
- 難易度
- スコア
- 各問題の詳細
  - 問題文
  - 選択した回答
  - 正解
  - 解説
  - 正答率

---

## 4. 非機能要件

### 4.1 性能要件
- ページ遷移：**1秒以内**
- クイズ採点：**即時（1秒以内）**
- データベース応答：**2秒以内**
- 問題データのキャッシュ：**5分**

### 4.2 セキュリティ要件
- **SQLインジェクション対策**
- **XSS対策**
- **CSRF対策**
- **セッション管理**
- **入力値のサニタイズ**

### 4.3 UI/UX要件
- **レスポンシブデザイン**
- **直感的な操作性**
- **アニメーションによる視覚的フィードバック**
- **エラー時の適切なメッセージ表示**
- **ローディング表示**

---

## 5. 使用技術

### 5.1 バックエンド
- **Python（Flask 2.2.5）**
- **PostgreSQL 16**
- **SQLAlchemy 1.4.46**
- **Flask-SQLAlchemy 2.5.1**
- **Flask-Migrate 4.0.4**
- **Flask-Login 0.6.2**
- **Werkzeug 2.2.3**

### 5.2 フロントエンド
- **HTML/CSS**
- **JavaScript**
- **Bootstrap 5**
- **Chart.js**（統計グラフ表示用）

### 5.3 開発環境
- **Replit**
- **Git（バージョン管理）**
- **python-dotenv 1.0.0**（環境変数管理）

---

## 6. プロジェクトの全体構成

以下のファイルがプロジェクトに含まれています：

- **`app.py`**  
  Flaskアプリケーションのメインファイル。ルーティング、ビュー関数、クイズロジック、セッション管理を含む。

- **`models.py`**  
  SQLAlchemyモデルの定義。ユーザーモデル、クイズ履歴モデル、スコア計算ロジックを含む。

- **`extensions.py`**  
  Flaskの拡張機能の初期化。データベース設定、マイグレーション管理を含む。

- **`quiz_data.py`**  
  クイズデータの管理。問題の取得、優先順位付け、統計計算を含む。

- **`config.py`**  
  環境変数、データベース設定、セキュリティ設定の管理。

- **`templates/`**  
  - base.html（ベーステンプレート）
  - grade_select.html（学年選択）
  - category_select.html（カテゴリー選択）
  - subcategory_select.html（サブカテゴリー選択）
  - difficulty_select.html（難易度選択）
  - quiz.html（クイズ画面）
  - result.html（結果画面）
  - dashboard.html（ダッシュボード）

- **`quiz_data/`**  
  学年別・カテゴリー別の問題データJSONファイル



# ローカル環境でFlaskアプリケーションを実行するための手順

## 必要なソフトウェア
---

## パッケージのインストール
1. 以下のコマンドで必要なパッケージをインストールします：

```bash
pip install flask flask-login flask-sqlalchemy psycopg2-binary sqlalchemy flask-migrate email-validator
```

2. .envファイルを作成します。
3. .envファイルを読み込めるようにします。

```bash
pip install python-dotenv
```

```app.pyファイルの先頭に以下のコードを追加
from dotenv import load_dotenv
load_dotenv()
```
---

## データベースのセットアップ

### データベース構造
このアプリケーションには以下の2つのテーブルが必要です：
- **users テーブル**：ユーザー情報を保存
- **quiz_attempts テーブル**：クイズの履歴を保存

### データベーススキーマの作成手順
1. まず、PostgreSQLデータベースを作成します。

```bash
psql -U postgres -p <password>
```
<password> : Tsuno202412
そして以下のSQLを実行：

```sql
CREATE TABLE users ( 
    id SERIAL PRIMARY KEY, 
    username VARCHAR(64) UNIQUE NOT NULL, 
    email VARCHAR(120) UNIQUE NOT NULL, 
    password_hash VARCHAR(256), 
    high_score INTEGER DEFAULT 0 
); 

CREATE TABLE quiz_attempts ( 
    id SERIAL PRIMARY KEY, 
    user_id INTEGER REFERENCES users(id), 
    category VARCHAR(50) NOT NULL, 
    difficulty VARCHAR(20) NOT NULL, 
    score INTEGER NOT NULL, 
    questions_history JSONB NOT NULL, 
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
);
```

### スキーマの確認方法
1. テーブル一覧の確認：

```bash
\dt
```

2. テーブル構造の確認：

```bash
\d users
\d quiz_attempts
```

3. データベースを終了します。
```bash
\q
```

### 環境変数の設定
以下の環境変数が設定されていることを確認：
- **DATABASE_URL**：自動的に設定されています
- **FLASK_SECRET_KEY**：セッション管理用の秘密鍵
これらの設定が完了すれば、アプリケーションはデータベースと正常に接続できるようになります。

### データベースのマイグレーション

```bash
flask db init
flask db migrate
flask db upgrade
```

FLASK_SECRET_KEYの設定:
任意の文字列を環境変数として設定する必要があります。

アプリケーションの起動:

python main.py
アプリケーションは http://localhost:5000 で起動します。


SQLALCHEMY_DATABASE_URI
DATABASE_URL
FLASK_SECRET_KEY
dev_key_for_quiz_app

注意点:
全てのファイルを同じディレクトリ構造で保存してください
static/とtemplates/のディレクトリ構造は維持してください
DATABASE_URLとFLASK_SECRET_KEYの環境変数を適切に設定してください
PostgreSQLの認証情報は環境に合わせて調整してください
もし環境変数の設定が難しい場合は、Replitの環境で実行することをお勧めします。Replitではこれらの設定が簡単に行えます。



# クイズ履歴ページに、各回の５問の回答結果とは別に、各問題のみにフォーカスして、複数回回答してた場合、問題文と正しい答に対して、回答した時間と選択した選択肢の内容、あっていた場合は緑、まちがっていた場合は赤で表示するようにしたい


具体的な実装の流れ：
1. models.py:
問題単位で履歴を集計するメソッドを追加
問題ごとの正答率を計算するメソッドを追加
app.py:
問題単位の履歴を取得するルートを追加
問題ごとの正答率を計算して返すロジックを追加
quiz_history.html:
タブ形式で「試行単位」と「問題単位」の表示を切り替えられるように修正
問題単位のビューを追加
各問題に対する時系列での回答履歴を表示
正解/不正解を色分けして表示
style.css:
タブ切り替えのスタイルを追加
問題単位の履歴表示用のスタイルを追加
時系列表示のためのスタイルを追加
この修正により、ユーザーは従来の試行単位での履歴表示と、問題単位での履歴表示を切り替えて確認できるようになります。問題単位の表示では、同じ問題に対する複数回の回答履歴を時系列で確認でき、各回答の正誤が色分けで一目で分かるようになります。

必要な修正について説明します：
models.pyの修正:
models.py:
  content: |-
    データベースモデルの定義
    機能:
    - クイズ履歴モデル
    - ユーザーモデル
    - 問題履歴の保存
    - スコア計算ロジック
    + 問題単位の履歴集計機能
    + 問題ごとの正答率計算

quiz_history.html:
  content: |-
    クイズ履歴ページ
    機能:
    - 過去の成績表示
    - 各問題の詳細表示
    - 正解・不正解の色分け表示
    - 選択した回答と正解の表示
    - タイムスタンプ表示
    - ダッシュボードへの戻るリンク
    + 問題単位の履歴タブ表示
    + 問題ごとの回答履歴一覧
    + 問題ごとの正答率表示
    + 時系列での回答履歴表示

style.css:
  content: |-
    アプリケーションのスタイル定義
    機能:
    - レイアウト
    - カラースキーム
    - レスポンシブデザイン
    - アニメーション効果
    - 正解/不正解の色分け
    - クイズ履歴のスタイリング
    + 問題単位の履歴表示スタイル
    + タブ切り替えのスタイル
    + 時系列表示のスタイル

app.py:
  content: |-
    Flaskアプリケーションのメインファイル
    機能:
    - ルーティング設定
    - アプリケーション初期化
    - ビュー関数の定義
    - セッション管理
    - クイズロジックの実装
    + 問題単位の履歴データ取得処理
    + 問題ごとの正答率計算処理

    supabaseとの連携
    Password: WV1fxjSD4aznmIYj



    # データベース設定
    DATABASE_URL = os.environ.get('DATABASE_URL', '')
    if DATABASE_URL.startswith('postgres://'):
        DATABASE_URL = DATABASE_URL.replace('postgres://', 'postgresql://', 1)
    
    SQLALCHEMY_DATABASE_URI = DATABASE_URL
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ENGINE_OPTIONS = {
        "pool_pre_ping": True,
        "pool_recycle": 300,
        "connect_args": {
            "sslmode": "require"
        }
    }
    
    # セキュリティ設定
    SECRET_KEY = os.environ.get('FLASK_SECRET_KEY', 'dev_key_for_quiz_app')


    # 開発時の主な課題と解決策

    ## 1. データベース接続の問題
    ### 課題
    - Supabaseへの接続が不安定
    - DATABASE_URLの形式が正しく認識されない
    - SSL証明書関連のエラー

    ### 解決策
    - DATABASE_URLの'postgres://'を'postgresql://'に置換
    - SSL設定を明示的に指定
    ```python
    if DATABASE_URL.startswith('postgres://'):
        DATABASE_URL = DATABASE_URL.replace('postgres://', 'postgresql://', 1)
    
    SQLALCHEMY_ENGINE_OPTIONS = {
        "connect_args": {"sslmode": "require"}
    }
    ```

    ## 2. セッション管理の問題
    ### 課題
    - セッションデータの不整合
    - クイズ途中でのセッション切れ
    - 複数タブでの競合

    ### 解決策
    - セッションキーの明確な定義
    - セッション有効期限の適切な設定
    - セッションデータの構造化
    ```python
    SESSION_KEYS = [
        'questions', 'current_question', 'score',
        'quiz_history', 'grade', 'category',
        'subcategory', 'difficulty'
    ]
    ```

    ## 3. 問題優先順位付けの実装
    ### 課題
    - 未回答問題の特定が困難
    - 正答率計算の精度
    - パフォーマンスの低下

    ### 解決策
    - 3段階の優先順位システム実装
        1. 未回答問題
        2. 低正答率問題（50%未満）
        3. その他の問題
    - 問題統計のキャッシュ化
    - バッチ処理による集計

    ## 4. フロントエンド連携
    ### 課題
    - 非同期更新時のデータ不整合
    - 画面遷移の遅延
    - エラーメッセージの表示タイミング

    ### 解決策
    - Ajaxによる部分更新の実装
    - プログレスバーの表示
    - エラーハンドリングの統一化
    ```javascript
    function showError(message) {
        const errorDiv = document.getElementById('error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 3000);
    }
    ```

    ## 5. データ整合性の確保
    ### 課題
    - トランザクション管理の複雑さ
    - 同時アクセス時のデータ競合
    - バックアップとリカバリ

    ### 解決策
    - SQLAlchemyのセッション管理の適切な利用
    - デッドロック対策の実装
    - 定期的なバックアップの自動化
    ```python
    try:
        db.session.begin_nested()
        # トランザクション処理
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        logger.error(f"Transaction failed: {e}")
    ```

     ## 6. supabaseとvercelの連携
DATABASE_URL:


形式: postgresql://postgres:password@db.cujvnutaucgrhleclmpq.supabase.co:5432/postgres
こちらはdb.をつける必要があります
なぜなら、これは直接のデータベース接続文字列だからです


SUPABASE_URL:


形式: https://cujvnutaucgrhleclmpq.supabase.co
こちらはdb.をつけません
これはSupabaseのAPIエンドポイントを指定するためのURLだからです


SQLALCHEMY_DATABASE_URI:


形式: postgresql://postgres:password@db.cujvnutaucgrhleclmpq.supabase.co:5432/postgres
こちらはdb.をつける必要があります
SQLAlchemyは直接データベースに接続するので、DATABASE_URLと同じ形式を使用します

    これでできるはず。

## 管理者画面　ローカル開発環境
### 環境変数の設定：
- export FLASK_APP=app.py
- export FLASK_ENV=development
### 管理者ユーザーの作成：
- flask create-admin admin@example.com admin
### 開発サーバーの起動：
- flask run
### ブラウザで http://localhost:5000 にアクセスし、以下の情報でログイン：
- メールアドレス: admin@example.com
- パスワード: admin

これにより、管理者権限でログインし、以下の機能をテストできます：
- 管理者ダッシュボード（/admin）
- ユーザー権限の編集（/admin/user/<user_id>）
- その他の管理者専用機能
開発環境では認証がスキップされ、データベースもローカルのPostgreSQLを使用するため、Supabaseに依存せずにテストができます。

## 小学1年生の主な学習単元
### 国語：

- ひらがな・カタカナの読み書き（清音、濁音、半濁音、長音、促音、拗音）
- 漢字の読み書き（80字程度の基本的な漢字）
- 物語文の読解（場面の様子や登場人物の気持ちを考える）
- 簡単な説明文の読解（文章の順序を理解する）
- スピーチや挨拶の仕方
- 簡単な作文（経験したことを書く）

### 算数：

- 数と計算（1から100までの数の理解）
- たし算とひき算（1桁同士の計算）
- 図形（身の回りにある形、まる・さんかく・しかく）
- 大きさくらべ（長さ、かさの比較）
- 時計の読み方（時刻の理解）
- ものの個数の数え方や分類の仕方

### 生活：

- 学校生活に慣れる（学校の施設や規則、友達との関わり）
- 家族や地域との関わり（自分の家族、通学路、公共施設）
- 季節の変化と生活（季節の特徴、遊び、行事）
- 動植物との関わり（生き物の観察、植物の栽培）
- 安全な生活（交通ルール、生活習慣）
- 自分の成長を振り返る（できるようになったこと）

## 小学2年生の主な学習単元
### 国語：

- 物語文の読解と感想文（場面の様子や登場人物の気持ちを読み取る）
- 説明文の読解（段落のつながりや要点を理解する）
- 漢字の読み書き（160字程度の新出漢字を学習）
- 日記・手紙・物語などの作文
- スピーチや話し合いの仕方

### 算数：

- たし算とひき算（2桁や3桁の計算）
- かけ算の意味と九九の習得
- 長さ・かさの単位と測定（cm、m、L、dL、mL）
- 時刻と時間の計算
- 図形（三角形、四角形、直角、対称な形）

### 生活：

- 季節と生活の関わり（植物の観察、季節の行事）
- 町探検（地域の様子や働く人々）
- 動植物の飼育・栽培（生き物の成長と世話）
- 身近な道具と遊び（おもちゃ作り、昔遊び）
- 自分の成長（できるようになったこと、家族との関わり）


## 小学3年生の主な学習単元
### 国語

- 漢字の読み書き（配当漢字約200字）
- 物語文の読解（あらすじ、登場人物）
- 説明文の読解（段落、要点）
- スピーチの仕方
- 音読と朗読
- 作文の書き方
- 熟語の意味と使い方
- 主語と述語の関係

### 算数

- かけ算九九の完成
- わり算の導入と計算
- 2桁×1桁の計算
- あまりのあるわり算
- 時間の計算
- 長さ・重さの単位
- 円と球
- 表とグラフ（棒グラフ）
- そろばん

### 理科（3年生から始まる）

- 昆虫と植物の観察
- 植物の育ち方
- 光と音の性質
- 磁石の性質
- 太陽と地面の様子
- 風やゴムの働き
- 物の重さと体積

### 社会（3年生から始まる）

- 身近な地域の様子
- 地図の読み方の基礎
- 市の様子と特徴
- 消防署や警察署の働き
- スーパーマーケットの仕組み
- 商店街と大型店
- 農家や工場の仕事
- 昔の道具と暮らし

## 小学4年生の主な学習単元
### 国語

- 漢字の読み書き（配当漢字約200字）
- 文章の要旨をとらえる
- 物語文の登場人物の心情理解
- 説明文の段落構成と中心文
- 慣用句・ことわざの理解と使用
- 手紙の書き方
- 作文・感想文の書き方

### 算数

- 大きな数（1億までの数）
- 概数と四捨五入
- 小数（小数第3位まで）
- 分数（真分数・仮分数・帯分数）
- 角度の測定と作図
- 面積（正方形・長方形）
- 垂直と平行
- 変わり方調べ（数量関係）
- 折れ線グラフ

### 理科

- 天気の様子と気温の変化
- 月と星（月の満ち欠け）
- 電気の働き（回路と電気の通り道）
- 空気と水の性質
- 金属の体積と温度
- 生き物の成長と体のつくり
- 季節と生き物の関係

### 社会

- 都道府県と地方区分
- 地図記号の読み方
- 自分たちの県の地理と産業
- 水源と水道
- ごみ処理と環境保護
- 災害から人々を守る工夫
- 伝統文化と地域の発展
- 特色ある地域の産業

## 小学5年生の主な学習単元
### 国語

- 漢字の読み書き（配当漢字約185字）
- 文学的な文章の読解（登場人物の心情、情景描写）
- 説明文の論理的な構成の理解
- 要約文の作成
- 複数の資料を比較して読む
- 和語・漢語・外来語の使い分け
- 文章の構成を考えた作文
- 討論や話し合いの進め方

### 算数

- 整数の性質（約数・倍数）
- 分数のたし算・ひき算
- 分数のかけ算・わり算
- 小数のかけ算・わり算
- 合同な図形
- 図形の面積（三角形、平行四辺形）
- 体積（立方体、直方体）
- 百分率とグラフ
- 比例の考え方

### 理科

- 植物の発芽と成長
- 花のつくりと実
- 動物の誕生
- 魚のたんじょう
- 雲と天気の変化
- 台風と気象情報
- 流れる水の働き
- 電磁石の性質
- 振り子の運動

### 社会

- 国土の位置と地形の特色
- 気候と農業や水産業との関係
- 工業生産と工業地域
- 情報産業とわたしたちの生活
- 運輸・通信と貿易
- わたしたちの生活と環境
- 国土の自然災害の防止
- 我が国の農業や水産業
- 我が国の工業生産

## 小学6年生の主な学習単元
### 国語

- 漢字の読み書き（配当漢字約190字）
- 文学的な文章の批評的な読み方
- 説明文や論説文の論理的な構造理解
- 複数の資料を関連付けて読む
- 表現の工夫を理解する（比喩、反復など）
- 文章の構成を工夫した作文
- 話し合いの効果的な進め方
- 日本語の特質（語感、敬語）

### 算数

- 分数の計算（加減乗除）
- 文字を使った式
- 円の面積
- 角柱と円柱の体積
- 縮図と拡大図
- 比とその利用
- 比例と反比例
- データの調べ方（平均値、中央値など）
- 場合の数と確率

### 理科

- 植物の養分と水の通り道
- 生物のつながり（食物連鎖）
- 人の体のつくりと働き
- 燃焼の仕組み
- 水溶液の性質
- てこの規則性
- 電気の利用
- 大地のつくりと変化
- 月と太陽（月の満ち欠け）

### 社会

- 歴史:縄文～古墳時代
- 歴史:飛鳥～奈良時代
- 歴史:平安時代
- 歴史:鎌倉時代
- 歴史:室町時代
- 歴史:安土桃山時代
- 歴史:江戸時代
- 歴史:明治時代
- 歴史:大正時代
- 歴史:昭和・平成時代
- 政治:日本国憲法
- 政治:国会・内閣・裁判所
- 政治:地方自治
- 政治:国際連合の働き
- 政治:世界の中の日本
# 多肢選択式クイズアプリケーション要件定義書

## 1. システム概要

### 1.1 目的
- ユーザーが様々なカテゴリーと難易度でクイズに挑戦できる
- 学習進捗を追跡・確認できる
- クイズの履歴を確認し、復習できる

### 1.2 主要機能

#### クイズ実施機能
- カテゴリー選択
- 難易度選択（easy, medium, hard）
- ランダムな問題出題（1セット5問）
- 選択肢のランダム表示
- 即時採点・フィードバック

#### 進捗管理機能
- カテゴリー別の進捗表示
- 難易度別の統計情報
  - 受験回数
  - 平均スコア
  - 最高スコア

#### 履歴確認機能
- カテゴリー・難易度別の履歴表示
- 各問題の詳細表示
  - 問題文
  - 選択した回答
  - 正解
  - 正誤判定

---

## 2. データベース設計

### 2.1 テーブル構成

#### クイズ履歴（QuizAttempt）
- **ID**（主キー）
- **ユーザーID**（外部キー）
- **カテゴリー**
- **難易度**
- **スコア**
- **問題履歴**（JSON）
- **タイムスタンプ**

#### ユーザー（User）
- **ID**（主キー）
- **ユーザー名**
- **メールアドレス**
- **パスワードハッシュ**
- **ハイスコア**

---

## 3. 画面設計

### 3.1 画面一覧

#### カテゴリー選択画面
- カテゴリー一覧表示
- ダッシュボードへのリンク

#### 難易度選択画面
- 難易度一覧表示
- 選択したカテゴリーの表示

#### クイズ画面
- 進捗バー
- 現在のスコア
- 問題文
- 選択肢（ランダム表示）
- 問題番号

#### 結果画面
- 最終スコア
- 不正解問題の復習セクション
- 再チャレンジボタン
- ダッシュボードへのリンク

#### ダッシュボード
- カテゴリー別進捗
- 難易度別統計
- 詳細履歴へのリンク

#### クイズ履歴画面
- 実施日時
- スコア
- 各問題の詳細（問題文、選択した回答、正解）

---

## 4. 非機能要件

### 4.1 性能要件
- ページ遷移：**1秒以内**
- クイズ採点：**即時（1秒以内）**
- データベース応答：**2秒以内**

### 4.2 セキュリティ要件
- **SQLインジェクション対策**
- **XSS対策**
- **CSRF対策**

### 4.3 UI/UX要件
- **レスポンシブデザイン**
- **直感的な操作性**
- **アニメーションによる視覚的フィードバック**
- **エラー時の適切なメッセージ表示**

---

## 5. 使用技術

### 5.1 バックエンド
- **Python（Flask）**
- **PostgreSQL**
- **SQLAlchemy**

### 5.2 フロントエンド
- **HTML/CSS**
- **JavaScript**
- **Bootstrap**

### 5.3 開発環境
- **Replit**
- **Git（バージョン管理）**

---

## 6. プロジェクトの全体構成

以下のファイルがプロジェクトに含まれています：

- **`pyproject.toml`**  
  プロジェクトの依存関係やメタデータを管理するファイル。poetryやpipenvなどのパッケージ管理ツールで使用されます。

- **`uv.lock`**  
  依存関係のロックファイル。特定のバージョンのパッケージを記録します。

- **`quiz_data.py`**  
  クイズデータを管理するためのスクリプト。データの取得や操作に関するロジックが含まれている可能性があります。

- **`app.py`**  
  Flaskアプリケーションのエントリーポイント。ルーティングやアプリケーションの設定が含まれています。

- **`def_structure_gemini.yaml`**  
  プロジェクトの構造やファイルの役割を定義したYAMLファイル。

- **`.replit`**  
  Replit環境での設定ファイル。Replitでの実行に関する設定が含まれています。

- **`extensions.py`**  
  Flaskの拡張機能やカスタム機能を定義するためのファイル。

- **`main.py`**  
  アプリケーションのメインロジックを含むファイル。エントリーポイントとして機能する可能性があります。

- **`models.py`**  
  データベースモデルを定義するファイル。ORM（Object-Relational Mapping）を使用している場合、データベースのテーブル構造が含まれています。

- **`replit.nix`**  
  Replit環境での依存関係や環境設定を管理するファイル。


# ローカル環境でFlaskアプリケーションを実行するための手順

## 必要なソフトウェア
- **Python 3.11以上**
- **PostgreSQL 16**

---

## パッケージのインストール
1. 以下のコマンドで必要なパッケージをインストールします：

```bash
pip install flask flask-login flask-sqlalchemy psycopg2-binary sqlalchemy flask-migrate email-validator
```

2. .envファイルを作成します。
3. .envファイルを読み込めるようにします。

```bash
pip install python-dotenv
```

```app.pyファイルの先頭に以下のコードを追加
from dotenv import load_dotenv
load_dotenv()
```
---

## データベースのセットアップ

### データベース構造
このアプリケーションには以下の2つのテーブルが必要です：
- **users テーブル**：ユーザー情報を保存
- **quiz_attempts テーブル**：クイズの履歴を保存

### データベーススキーマの作成手順
1. まず、PostgreSQLデータベースを作成します。

```bash
psql -U postgres -p <password>
```
<password> : Tsuno202412
そして以下のSQLを実行：

```sql
CREATE TABLE users ( 
    id SERIAL PRIMARY KEY, 
    username VARCHAR(64) UNIQUE NOT NULL, 
    email VARCHAR(120) UNIQUE NOT NULL, 
    password_hash VARCHAR(256), 
    high_score INTEGER DEFAULT 0 
); 

CREATE TABLE quiz_attempts ( 
    id SERIAL PRIMARY KEY, 
    user_id INTEGER REFERENCES users(id), 
    category VARCHAR(50) NOT NULL, 
    difficulty VARCHAR(20) NOT NULL, 
    score INTEGER NOT NULL, 
    questions_history JSONB NOT NULL, 
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP 
);
```

### スキーマの確認方法
1. テーブル一覧の確認：

```bash
\dt
```

2. テーブル構造の確認：

```bash
\d users
\d quiz_attempts
```

3. データベースを終了します。
```bash
\q
```

### 環境変数の設定
以下の環境変数が設定されていることを確認：
- **DATABASE_URL**：自動的に設定されています
- **FLASK_SECRET_KEY**：セッション管理用の秘密鍵
これらの設定が完了すれば、アプリケーションはデータベースと正常に接続できるようになります。

### データベースのマイグレーション

```bash
flask db init
flask db migrate
flask db upgrade
```

FLASK_SECRET_KEYの設定:
任意の文字列を環境変数として設定する必要があります。

アプリケーションの起動:

python main.py
アプリケーションは http://localhost:5000 で起動します。


SQLALCHEMY_DATABASE_URI
DATABASE_URL
FLASK_SECRET_KEY
dev_key_for_quiz_app

注意点:
全てのファイルを同じディレクトリ構造で保存してください
static/とtemplates/のディレクトリ構造は維持してください
DATABASE_URLとFLASK_SECRET_KEYの環境変数を適切に設定してください
PostgreSQLの認証情報は環境に合わせて調整してください
もし環境変数の設定が難しい場合は、Replitの環境で実行することをお勧めします。Replitではこれらの設定が簡単に行えます。



# クイズ履歴ページに、各回の５問の回答結果とは別に、各問題のみにフォーカスして、複数回回答してた場合、問題文と正しい答に対して、回答した時間と選択した選択肢の内容、あっていた場合は緑、まちがっていた場合は赤で表示するようにしたい


具体的な実装の流れ：
1. models.py:
問題単位で履歴を集計するメソッドを追加
問題ごとの正答率を計算するメソッドを追加
app.py:
問題単位の履歴を取得するルートを追加
問題ごとの正答率を計算して返すロジックを追加
quiz_history.html:
タブ形式で「試行単位」と「問題単位」の表示を切り替えられるように修正
問題単位のビューを追加
各問題に対する時系列での回答履歴を表示
正解/不正解を色分けして表示
style.css:
タブ切り替えのスタイルを追加
問題単位の履歴表示用のスタイルを追加
時系列表示のためのスタイルを追加
この修正により、ユーザーは従来の試行単位での履歴表示と、問題単位での履歴表示を切り替えて確認できるようになります。問題単位の表示では、同じ問題に対する複数回の回答履歴を時系列で確認でき、各回答の正誤が色分けで一目で分かるようになります。

必要な修正について説明します：
models.pyの修正:
models.py:
  content: |-
    データベースモデルの定義
    機能:
    - クイズ履歴モデル
    - ユーザーモデル
    - 問題履歴の保存
    - スコア計算ロジック
    + 問題単位の履歴集計機能
    + 問題ごとの正答率計算

quiz_history.html:
  content: |-
    クイズ履歴ページ
    機能:
    - 過去の成績表示
    - 各問題の詳細表示
    - 正解・不正解の色分け表示
    - 選択した回答と正解の表示
    - タイムスタンプ表示
    - ダッシュボードへの戻るリンク
    + 問題単位の履歴タブ表示
    + 問題ごとの回答履歴一覧
    + 問題ごとの正答率表示
    + 時系列での回答履歴表示

style.css:
  content: |-
    アプリケーションのスタイル定義
    機能:
    - レイアウト
    - カラースキーム
    - レスポンシブデザイン
    - アニメーション効果
    - 正解/不正解の色分け
    - クイズ履歴のスタイリング
    + 問題単位の履歴表示スタイル
    + タブ切り替えのスタイル
    + 時系列表示のスタイル

app.py:
  content: |-
    Flaskアプリケーションのメインファイル
    機能:
    - ルーティング設定
    - アプリケーション初期化
    - ビュー関数の定義
    - セッション管理
    - クイズロジックの実装
    + 問題単位の履歴データ取得処理
    + 問題ごとの正答率計算処理
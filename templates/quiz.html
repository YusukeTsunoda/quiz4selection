{% extends "base.html" %} {% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h2 class="text-center">
            問題 {{ current_question + 1 }} / {{ total_questions }}
          </h2>
        </div>
        <div class="card-body">
          <h3 class="card-title mb-4">{{ question }}</h3>

          <!-- ヒントボタンと表示領域を追加 -->
          <div class="mb-3">
            <button id="hintButton" class="btn btn-info" onclick="showHint()">
              <i class="fas fa-lightbulb"></i> ヒントを表示
            </button>
            <div
              id="hintText"
              class="alert alert-info mt-2"
              style="display: none"
            ></div>
          </div>

          <div class="options">
            {% for option in options %}
            <div class="option mb-3">
              <button
                class="btn btn-outline-primary w-100 option-button"
                onclick="submitAnswer({{ loop.index0 }})"
              >
                {{ option }}
              </button>
            </div>
            {% endfor %}
          </div>

          <div id="result" class="mt-3" style="display: none">
            <div id="correct-answer" class="alert alert-success">
              正解です！
            </div>
            <div id="wrong-answer" class="alert alert-danger">不正解です。</div>
            <div id="explanation" class="alert alert-info"></div>
          </div>

          <div class="text-center mt-3">
            <span id="timer" class="badge bg-secondary">残り時間: 60秒</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let timer;
  let timeLeft = 60;
  let questionData = {{ question_data | tojson | safe }};

  function startTimer() {
      timer = setInterval(function() {
          timeLeft--;
          document.getElementById('timer').textContent = `残り時間: ${timeLeft}秒`;

          if (timeLeft <= 0) {
              clearInterval(timer);
              submitAnswer(-1); // タイムアウト時は-1を送信
          }
      }, 1000);
  }

  function showHint() {
      const hintText = document.getElementById('hintText');
      const hint = questionData.hint;

      if (hint) {
          hintText.textContent = hint;
          hintText.style.display = 'block';
      } else {
          hintText.textContent = 'このクイズにはヒントがありません。';
          hintText.style.display = 'block';
      }
  }

  function submitAnswer(selectedIndex) {
      clearInterval(timer);

      const timeTaken = 60 - timeLeft;

      fetch('/submit_answer', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
          },
          body: JSON.stringify({
              selected: selectedIndex,
              time_taken: timeTaken
          })
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              document.getElementById('result').style.display = 'block';

              if (data.isCorrect) {
                  document.getElementById('correct-answer').style.display = 'block';
                  document.getElementById('wrong-answer').style.display = 'none';
              } else {
                  document.getElementById('correct-answer').style.display = 'none';
                  document.getElementById('wrong-answer').style.display = 'block';
              }

              // 説明を表示
              const explanation = questionData.explanation;
              if (explanation) {
                  document.getElementById('explanation').textContent = explanation;
                  document.getElementById('explanation').style.display = 'block';
              }

              // 全ての選択肢ボタンを無効化
              const buttons = document.getElementsByClassName('option-button');
              for (let button of buttons) {
                  button.disabled = true;
              }

              // ヒントボタンを無効化
              document.getElementById('hintButton').disabled = true;

              if (data.isLastQuestion) {
                  setTimeout(() => {
                      window.location.href = data.redirectUrl;
                  }, 3000);
              } else {
                  setTimeout(() => {
                      window.location.href = '/next_question';
                  }, 3000);
              }
          } else {
              alert('エラーが発生しました: ' + data.error);
          }
      })
      .catch(error => {
          console.error('Error:', error);
          alert('エラーが発生しました');
      });
  }

  window.onload = function() {
      startTimer();
  }
</script>
{% endblock %}
